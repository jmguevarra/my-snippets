--parentid: text
BEGIN
    RETURN (
        WITH RECURSIVE folder_tree AS (
            -- Start from the given parent folder
            SELECT id, name, parent_id
            FROM fm_folders
            WHERE id = parentid::uuid

            UNION ALL

            -- Recursively get all subfolders
            SELECT f.id, f.name, f.parent_id
            FROM fm_folders f
            INNER JOIN folder_tree ft ON f.parent_id = ft.id
        )
        SELECT jsonb_agg(row_to_json(result))
        FROM (
            -- Files
            SELECT fi.id, fi.name, 'file' AS type, fi.folder_id AS parent_id
            FROM fm_files fi
            JOIN folder_tree ft ON fi.folder_id = ft.id

            UNION ALL
            -- Folders (except root)
            SELECT ft.id, ft.name, 'folder' AS type, ft.parent_id
            FROM folder_tree ft
            WHERE ft.id != parentid::uuid
        ) result
    );
END;
